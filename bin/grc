#!/bin/bash

EndsWith() {
  [[ $1 = *"$2" ]]
  # test "${1%$2}" != "$1"
}
GetExtension:() {
  local _slash=/
  local v="$1"; shift
  local cand="${1##*.}"
  if test "$cand" != "$1" -a "${cand/$_slash/}" == "$cand"; then
    eval "$v='.${1##*.}'"
  else
    eval "$v=''"
  fi
}

declare color_option=--color=auto

declare -a findsrc_args
declare -a args_option
declare -a args_file
regexp=

declare fDefaultExcludes=

while (($#)); do
  declare arg="$1"
  shift
  case "$arg" in
  (--help)
    cat <<EOF
usage: grc [options] pattern [files...]

options
  --help
  -C NUMBER
  --color

findsrc options:
  -x EXTENSIONS
  -a
  -b
  -t SRCTYPE
  --exclude=PATTERN
EOF
    exit
    ;;
  (-C)
    args_option[${#args_option[@]}]='-C'
    args_option[${#args_option[@]}]="$1"
    shift 1 ;;
  (-C?*)
    args_option[${#args_option[@]}]='-C'
    args_option[${#args_option[@]}]="${arg:2}" ;;
  (--color)
    color_option=--color=always ;;
  (-x)
    findsrc_args+=("$arg" "$1")
    shift 1 ;;
  (-[abAB]|--exclude=*|--type=*|--exntesion=*)
    findsrc_args+=("$arg") ;;
  (-t) # findsrc type
    findsrc_args+=("$arg" "$1")
    shift 1 ;;
  (-t*) # findsrc type
    findsrc_args+=(-t "${arg:2}") ;;
  (-*)
    echo "$0: unknown option ($arg)" >&2
    exit 1 ;;
  ('')
    echo "$0: empty argument is invalid" >&2
    exit 1 ;;
  (--excludes-default)
    fDefaultExcludes=1 ;;
  (*)
    if [[ $regexp ]]; then
      if [[ $fDefaultExcludes ]]; then
        EndsWith "$arg" '~' && continue

        declare ext
        GetExtension: ext "$arg"
        case "$ext" in
        (.c|.cpp|.cc|.C|.cxx|.h|.hpp|.hxx|.hh|.inl) ;;
        (.js|.ctx|.css) ;;
        (*)
          continue ;;
        esac
      fi
      args_file+=("$arg")
    else
      regexp="$arg"
    fi ;;
  esac
done

if [[ -z $regexp ]]; then
  echo "$0: pattern is not specified!" >&2
  exit 2
fi

if ((${#args_file[@]}==0)); then
  args_file=($(findsrc "${findsrc_args[@]}"))
fi

if ((${#args_file[@]}>=1)); then
  grep -E $color_option -n -H "${args_option[@]}" "$regexp" "${args_file[@]}"
fi
